# Основы ClickHouse

ClickHouse - колоночная СУБД, которая не имеет накладных расходов на работу с широкими таблицами с большим количеством столбцов, а значит, позволяет хранить данные в денормализованном виде.

### Где применяют ClickHouse

ClickHouse эффективно работает в проектах любого масштаба: от MVP до аналитических систем крупных корпораций. Применяется в:

- Финансовых технологиях
- Научных исследованиях
- Аналитических сервисах (маркетинг, маркетплейсы)
- Работе складов и производств (анализ операций, метрики объектов)

### ClickHouse подходит для

- Быстрых запросов по неагрегированной статистике
- Хранения и чтения логов
- SIEM - управления информационной безопасностью и событиями безопасности
- Хранения и обработки денормализованных данных
- Хранения телеметрии, метрик по клиентам и устройствам
- Хранения статистики (например, источник данных в Grafana)

### Когда ClickHouse не нужна

- Сложные запросы с использованием JOIN между большими таблицами (требуют много памяти и передачи данных)
- Выборки отдельных строк с низкой задержкой
- OLTP-нагрузка с частыми изменениями и обновлениями данных в реальном времени

ClickHouse рассчитана на увеличение памяти для кеширования часто используемых данных. Для аналитических запросов с большими объёмами данных время ответа меньше, чем у других СУБД.

## Ключевые особенности ClickHouse

- **Колоночное хранение:** данные каждой колонки хранятся в отдельном файле, при чтении распаковываются только нужные колонки, что ускоряет работу.
- **Векторный движок:** обработка данных по векторам (кусочкам столбцов) с использованием SIMD-инструкций и эффективным кешированием CPU.
- **Естественная параллелизация:** большие запросы автоматически распараллеливаются на все доступные ресурсы сервера.
- **Работа в однонодовой и кластерной конфигурации:** позволяет масштабировать обработку данных.
- **Масштабируемость:** добавление новых узлов для обработки петабайтов данных.
- **Децентрализация и отказоустойчивость:** асинхронная multi-master репликация с автоматическим восстановлением данных.
- **OLAP-ориентированность:** аналитическая обработка данных в реальном времени, без поддержки транзакционности OLTP.

:::details Что такое SIMD-инструкции и зачем они нужны в ClickHouse

**SIMD** (Single Instruction, Multiple Data) - это технология, при которой процессор может выполнять одну и ту же операцию сразу над несколькими данными одновременно.

### Как это работает

- Обычно процессор обрабатывает данные по одному элементу за раз (например, складывает два числа).
- С SIMD процессор может, например, сложить сразу 4 или 8 пар чисел за одну команду.
- Это достигается за счёт специальных инструкций и расширенных регистров процессора.

В ClickHouse использование SIMD-инструкций особенно важно из-за её колоночной структуры хранения данных. Поскольку данные хранятся по столбцам, а аналитические запросы часто требуют выполнения одной и той же операции над большим количеством значений в одном столбце (например, фильтрация, агрегация), SIMD-инструкции позволяют значительно ускорить эти вычисления. Вместо того чтобы процессор обрабатывал каждое значение отдельно, SIMD позволяет ему выполнять одну операцию сразу над несколькими значениями одновременно. Например, если нужно сложить два столбца, каждый из которых содержит 1000 чисел, без SIMD процессор выполнит 1000 операций сложения. С использованием SIMD, когда процессор может сложить, скажем, 8 пар чисел одновременно, общее количество операций сократится до 125, что значительно повышает скорость обработки данных.

:::

## Режимы работы ClickHouse

### Один узел (Single-node)

- Простая установка и запуск сервиса.
- Подходит, если:
  - Не требуется отказоустойчивость
  - Не нужно горизонтальное масштабирование
  - Объём данных умещается на одном сервере
  - Ресурсов CPU и RAM достаточно для нагрузки

### Кластер

- Требуется ZooKeeper™ (3 или 5 узлов) или ClickHouse Keeper для координации.
- ZooKeeper - сервис-координатор на Java от Apache.
- ClickHouse Keeper - альтернатива ZooKeeper, совместимая с ним.
- Хранит конфигурацию кластера, метаданные, очереди задач, информацию о реплицируемых таблицах.
- Позволяет настраивать репликацию и шардирование для масштабирования и повышения отказоустойчивости.
- Поддержка MPP (выполнение одного запроса на нескольких узлах одновременно).
- Репликация и шардирование могут использоваться вместе или по отдельности.

## Отличия ClickHouse от других СУБД

- Оптимизирована под OLAP-задачи, а не OLTP.
- Колоночное хранение и векторная обработка данных.
- Нет поддержки транзакций в режиме реального времени.
- Высокая производительность при аналитических запросах по большим объёмам данных.

## Интерфейсы подключения

ClickHouse поддерживает два протокола:

1. **Native TCP**:

   - Используется в клиенте командной строки и для взаимодействия между серверами
   - Имеет меньше накладных расходов
   - Реализован на C++, Go, Python

2. **HTTP**:
   - Более универсальный, реализован практически во всех языках
   - Более ограничен по сравнению с нативным интерфейсом
   - Имеет больше накладных расходов и меньшую производительность

Оба интерфейса поддерживают шифрование TLS.

## Инструменты для подключения

Официально поддерживаемые:

- Консольный клиент
- JDBC-драйвер
- ODBC-драйвер
- Клиентская библиотека C++

Для большинства языков программирования существуют библиотеки, реализующие как Native, так и HTTP-подключения.

## Работа с ClickHouse через DBeaver

DBeaver - это универсальный инструмент с графическим интерфейсом для работы с различными СУБД, включая ClickHouse. Для подключения к ClickHouse через DBeaver:

1. **Установка DBeaver**:

   - Скачайте и установите DBeaver с официального сайта (dbeaver.io)
   - Доступны версии для Windows, macOS и Linux

2. **Создание подключения**:

   - Нажмите "Новое соединение" в меню или на панели инструментов
   - Выберите "ClickHouse" из списка доступных баз данных
   - Введите параметры подключения:
     - Хост (адрес сервера ClickHouse)
     - Порт (по умолчанию 8123 для HTTP или 9000 для TCP)
     - База данных (имя базы данных)
     - Имя пользователя и пароль
   - При необходимости настройте SSL/TLS для безопасного подключения
