# Структура базы данных

## Основные движки таблиц в ClickHouse

ClickHouse предлагает разнообразные движки таблиц, каждый из которых оптимизирован для определенных сценариев использования. Движок таблицы определяет ключевые аспекты работы с данными: способ хранения, поддерживаемые типы запросов, возможности индексации, многопоточность и репликацию.

| ENGINE          | SELECT    | INSERT | DELETE | UPDATE | persistent | indexes |
| --------------- | --------- | ------ | ------ | ------ | ---------- | ------- |
| \*MergeTree     | +         | +      | +      | +      | +          | +       |
| \*Log           | +         | +      | +      | -      | +          | -       |
| EmbeddedRocksDB | +         | +      | +      | -      | +          | -       |
| URL             | +         | -/+    | -      | -      | external   | -       |
| Buffer          | +         | +      | -      | -      | +          | -       |
| Memory          | +         | +      | +      | +      | -          | -       |
| Set             | (only IN) | -      | -      | -      | +          | -       |
| Join            | +         | -      | -      | -      | +          | -       |
| PostgreSQL      | +         | +      | -      | -      | external   | -       |
| Kafka           | +         | -      | -      | -      | external   | -       |

Примечания:

- `+` - поддерживается

- `-` - не поддерживается

- `- / +` - частичная поддержка или зависит от конфигурации

- `external` - данные хранятся во внешней системе

- `(only IN)` - поддерживается только операция IN

- `persistent` - "постоянное хранение" (указывает, сохраняются ли данные на диск или во внешней системе)

- `indexes` - "индексы" (указывает, поддерживает ли движок индексацию данных)

## Семейство движков \*MergeTree

Движки семейства \*MergeTree - это основа ClickHouse и наиболее часто используемый тип таблиц в этой СУБД. Они предназначены для хранения больших объёмов данных на диске в сжатом виде и поддерживают полный набор операций DML: `SELECT`, `INSERT`, `DELETE`, `UPDATE`. Благодаря этому можно не только читать и добавлять данные, но и выполнять их удаление и обновление.

Ключевая особенность MergeTree - поддержка индексов, в том числе уникальных для ClickHouse индексов пропуска данных (разреженных индексов). Эти индексы позволяют эффективно фильтровать данные и ускоряют выполнение аналитических запросов на больших таблицах. Таблицы MergeTree могут быть оптимизированы с помощью партиционирования и сортировки по ключу, что дополнительно увеличивает производительность при работе с большими объёмами информации.

## Разновидности движков семейства MergeTree

Семейство MergeTree в ClickHouse включает несколько разновидностей движков, каждая из которых обладает своей спецификой и дополнительными возможностями.

### Базовый MergeTree

Движок MergeTree является локальной таблицей, которая хранит данные на диске в исходном виде без каких-либо дополнительных преобразований. Он обеспечивает эффективное хранение и быстрый доступ к данным, поддерживает операции вставки, чтения, удаления и обновления, а также использование разреженных индексов для ускорения запросов.

### Расширенные движки на базе MergeTree

Помимо базового MergeTree, существуют движки, которые наследуют его архитектуру хранения данных, но добавляют специальные механизмы, работающие во время фонового процесса слияния данных (merge). Эти механизмы позволяют реализовать дополнительные функции, такие как агрегация и дедупликация.

- **AggregatingMergeTree** и **SummingMergeTree** - используются для хранения агрегированных данных, например, суммарных значений за разные периоды. Они позволяют автоматически агрегировать данные при слиянии частей таблицы, что упрощает и ускоряет аналитические вычисления.

- **ReplacingMergeTree** - предназначен для автоматического удаления дубликатов записей, оставляя только последнюю версию данных по ключу. Это полезно, когда данные могут обновляться путём вставки новых версий.

- **CollapsingMergeTree (с параметром sign)** - реализует механизм «свёртывания» строк с противоположными значениями sign, что позволяет эффективно удалять отменённые записи и поддерживать консистентность данных.

- **VersionedCollapsingMergeTree** - расширяет возможности CollapsingMergeTree, добавляя поддержку версионирования записей для более точного контроля обновлений и удаления.

Рассмотрим их подробнее.

## Движок SummingMergeTree

Движок SummingMergeTree предназначен для хранения данных с автоматической агрегацией по сумме значений в определённых числовых столбцах. Основной принцип работы этого движка заключается в том, что при слиянии частей таблицы все строки, имеющие одинаковый ключ сортировки (первичный ключ), объединяются в одну запись. При этом для указанных в параметрах движка числовых столбцов происходит суммирование значений.

В отличие от AggregatingMergeTree, который поддерживает широкий набор агрегатных функций, SummingMergeTree умеет работать только с операцией суммирования.

Для столбцов, входящих в ключ сортировки, значения остаются без изменений, так как они определяют уникальность записи. Для остальных столбцов, не участвующих в суммировании и не входящих в ключ, выбирается одно из значений, случайным образом взятое из объединяемых строк.

Если в таблице используются вложенные структуры (например, вложенные массивы или объекты), суммирование происходит по соответствующим полям внутри этих структур.

Для получения окончательных агрегированных данных, учитывающих все слияния, можно использовать модификатор `FINAL` в операторе `SELECT`. Это позволяет получить результат, в котором все промежуточные части данных, ещё не объединённые в процессе слияния, будут учтены.

## Семейство движков \*Log

Движки семейства \*Log предназначены для сценариев, где требуется быстро записывать небольшие объёмы данных (до миллиона строк) в большое количество таблиц, а затем массово читать эти записи. Они идеально подходят для временных таблиц, тестовых данных или хранения промежуточных результатов.

Однако, в отличие от MergeTree, таблицы Log не поддерживают операции `UPDATE` и `DELETE` - изменить или удалить уже записанные данные невозможно. Также движки Log не поддерживают индексы, поэтому поиск по таким таблицам менее эффективен при больших объёмах данных. Основное преимущество - простота и высокая скорость вставки и чтения для небольших таблиц.

## Движок EmbeddedRocksDB

ClickHouse включает встроенный движок EmbeddedRocksDB, который предназначен для хранения и обработки данных в формате key-value. Этот движок основан на RocksDB - высокопроизводительной базе данных, являющейся форком Google LevelDB. RocksDB поддерживает такие возможности, как транзакционность, снапшоты (снимки состояния базы), фильтры Блума для ускорения поиска, а также `TTL` (время жизни) для ключей, что позволяет автоматически удалять устаревшие данные.

На данный момент движок EmbeddedRocksDB в ClickHouse поддерживает операции чтения (`SELECT`) и вставки данных (`INSERT`). Однако операции удаления (`DELETE`) и обновления (`UPDATE`) пока не реализованы.

## Движок URL

Движок URL позволяет работать с данными, расположенными на удалённом сервере, не сохраняя их локально в ClickHouse. Запросы к таблице с этим движком транслируются в HTTP-запросы: операции `SELECT` преобразуются в `GET`-запросы, а `INSERT` - в `POST`-запросы.

При этом модификация данных (`DELETE`, `UPDATE`) не поддерживается, так как движок URL не хранит данные локально и лишь выступает в роли прокси к удалённому источнику.

Таким образом, движок URL удобен для интеграции с внешними сервисами и получения данных из них в режиме реального времени, без необходимости их дублирования в ClickHouse.

## Движок Buffer

Движок Buffer предназначен для временного накопления данных в оперативной памяти перед их записью в основную таблицу-приёмник на диске. Он накапливает вставляемые данные в ОЗУ и при достижении определённых пороговых значений автоматически сбрасывает их в приёмник. При этом, если сервер базы данных перезапускается, данные из буфера не теряются - они сохраняются на диске и будут записаны в основную таблицу при следующем запуске. Такой механизм позволяет повысить производительность массовых вставок, сглаживая нагрузку на диск.

Для движка Buffer доступны операции `SELECT` и `INSERT`. Операции удаления и обновления не поддерживаются.

## Движок Memory

Движок Memory хранит все данные исключительно в оперативной памяти, что обеспечивает очень высокую скорость чтения и записи. Он поддерживает операции `SELECT`, `INSERT`, `UPDATE` и `DELETE`, позволяя модифицировать и удалять данные.

Однако при перезапуске сервера все данные в таблицах с движком Memory теряются, так как они не сохраняются на диск. Кроме того, данный движок не поддерживает индексы, что ограничивает возможности оптимизации запросов.

## Движок Set

Движок Set используется для хранения набора значений, которые применяются в правой части оператора `IN` в SQL-запросах. Прямое выполнение `SELECT` из такой таблицы невозможно - она служит исключительно для подстановки значений в условия фильтрации.

В таблицу Set можно записывать данные с помощью команды `INSERT`. Персистентность данных (сохранение на диск) задаётся специальной опцией при создании таблицы.

Таким образом, движок Set удобен для реализации быстрых проверок вхождения значений в заранее определённый набор без необходимости полноценного хранения и обработки данных.

## Движок Join

Движок Join предназначен для предварительной подготовки данных, которые будут использоваться в операциях соединения (`JOIN`) в запросах ClickHouse. В таблицах с этим движком данные полностью загружаются и всегда доступны для быстрого соединения и фильтрации. Движок поддерживает операции чтения (`SELECT`), вставки (`INSERT`) и удаления (`DELETE`), но не позволяет обновлять (`UPDATE`) уже существующие записи. Это делает его удобным для хранения справочных наборов данных, которые часто используются в `JOIN`-операциях.

## Движок PostgreSQL

Движок PostgreSQL предоставляет возможность работать с внешними таблицами, находящимися в базе данных PostgreSQL, напрямую из ClickHouse. С помощью этого движка можно выполнять операции чтения (`SELECT`) и вставки (`INSERT`) данных, используя ClickHouse как интерфейс доступа к внешним данным. Данные физически хранятся во внешней системе, а не в ClickHouse. Это позволяет интегрировать ClickHouse с PostgreSQL и использовать возможности обеих систем в рамках одной аналитической задачи.

## Движок Kafka

Движок Kafka предназначен для интеграции с потоковыми данными из Apache Kafka. Он не хранит данные самостоятельно, а используется для подписки на потоки данных (consumer) и публикации данных (producer) в Kafka-топики. Такой подход позволяет ClickHouse эффективно обрабатывать и анализировать потоковые данные в реальном времени, используя возможности Kafka для обмена сообщениями между системами.
