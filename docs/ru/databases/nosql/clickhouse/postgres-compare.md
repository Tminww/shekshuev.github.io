# Сравнение ClickHouse и PostgreSQL

Сейчас мы сравним возможности ClickHouse и PostgreSQL для аналитической обработки данных на реальном примере - открытом датасете COVID-19 Open Data от Google. Этот датасет объединяет эпидемиологическую, демографическую, экономическую, медицинскую и другую информацию по тысячам регионов мира, предоставляя уникальные возможности для анализа на больших объёмах данных.

### Почему важен выбор СУБД для аналитики

Современные задачи анализа данных требуют работы с огромными таблицами, сложными агрегациями и быстрыми откликами на запросы. Традиционные реляционные СУБД, такие как PostgreSQL, отлично подходят для транзакционной нагрузки и сложных бизнес-операций, но могут уступать специализированным аналитическим решениям при работе с большими объёмами данных.

ClickHouse - это колоночная аналитическая СУБД, специально спроектированная для быстрого выполнения запросов по миллионам и миллиардам строк. Благодаря особенностям архитектуры, таким как хранение данных по столбцам, векторная обработка и эффективное сжатие, ClickHouse обеспечивает высокую скорость агрегаций и выборок даже на очень больших датасетах.

### О датасете

COVID-19 Open Data - это глобальный мета-набор, включающий данные по эпидемиологии, демографии, экономике, здравоохранению, мобильноcти, погоде и мерам реагирования правительств. Данные агрегированы по регионам и датам, что позволяет строить сложные аналитические отчёты и визуализации на разных уровнях детализации (страна, регион, город и т.д.).

# Описание датасета `epidemiology.csv`

Датасет **COVID-19 Open Data** от Google содержит эпидемиологические данные по тысячам регионов мира, представленные в формате временного ряда.

## Назначение

Используется для анализа динамики COVID-19:

- по странам, регионам и городам;
- с возможностью анализа на разных уровнях детализации;
- с фокусом на количество случаев, смертей, выздоровлений и тестов.

## Структура таблицы

| Поле                   | Описание                                                   |
| ---------------------- | ---------------------------------------------------------- |
| `date`                 | Дата записи (формат YYYY-MM-DD)                            |
| `key`                  | Уникальный идентификатор региона (страна/регион/подрегион) |
| `new_confirmed`        | Новые подтвержденные случаи за дату                        |
| `new_deceased`         | Новые случаи смерти за дату                                |
| `new_recovered`        | Новые выздоровевшие за дату                                |
| `new_tested`           | Новые тесты за дату                                        |
| `cumulative_confirmed` | Общее количество подтвержденных случаев на дату            |
| `cumulative_deceased`  | Общее количество смертей на дату                           |
| `cumulative_recovered` | Общее количество выздоровевших на дату                     |
| `cumulative_tested`    | Общее количество тестов на дату                            |

## Пример кодов регионов России

Поле `key` отражает административную иерархию. Примеры:

- `RU` — Россия (вся страна)
- `RU-MOW` — Москва
- `RU-SPE` — Санкт-Петербург
- `RU-KDA` — Краснодарский край
- `RU-SVE` — Свердловская область
- `RU-NVS` — Новосибирская область
- `RU-KHM` — Ханты-Мансийский автономный округ

Формат соответствует стандарту ISO 3166-2 и может включать до 3 уровней (например, `US-CA-06037` для округа в США).

## Особенности

- Некоторые значения могут быть пустыми (NULL).
- Удобен для временного анализа, фильтрации по регионам и агрегаций.
- Хорошо подходит для OLAP-нагрузки.

### Цель сравнения

В ходе этого вопроса мы:

- Покажем, как устроены архитектуры ClickHouse и PostgreSQL с точки зрения аналитики.
- Сравним их производительность и удобство работы на реальных аналитических сценариях с использованием COVID-19 Open Data.
- Продемонстрируем, почему ClickHouse является предпочтительным выбором для задач, связанных с анализом больших объёмов данных, агрегациями и быстрой обработкой запросов.

## Импорт данных

### PosgreSQL

Создайте таблицу:

```sql
CREATE TABLE epidemiology (
    date DATE,
    key TEXT,
    new_confirmed BIGINT,
    new_deceased BIGINT,
    new_recovered BIGINT,
    new_tested BIGINT,
    cumulative_confirmed BIGINT,
    cumulative_deceased BIGINT,
    cumulative_recovered BIGINT,
    cumulative_tested BIGINT
);
```

С помощью команды `COPY` переместите содержимое csv в таблицу:

```sql
COPY epidemiology FROM '/tmp/epidemiology.csv' DELIMITER ',' CSV HEADER;
```

Обратите внимание, что нужно указать правильный путь к файлу `epidemiology.csv`.

### ClickHouse

Создайте таблицу:

```sql
CREATE TABLE epidemiology
(
    date Date,
    key String,
    new_confirmed Int32,
    new_deceased Int32,
    new_recovered Int32,
    new_tested Int32,
    cumulative_confirmed Int32,
    cumulative_deceased Int32,
    cumulative_recovered Int32,
    cumulative_tested Int32
)
ENGINE = MergeTree()
ORDER BY (key, date);
```

В ClickHouse нет аналога функции `COPY`. Поэтому загрузим данные с помощью консольного клиента. Для этого в командной строке выполните:

```bash
clickhouse-client --password --query="INSERT INTO epidemiology FORMAT CSVWithNames" < /tmp/epidemiology.csv
```

Загрузка данных произошла значительно быстрее, чем в PostgreSQL.

Обратите внимание, что нужно указать правильный путь к файлу `epidemiology.csv`.
