## Что такое ClickHouse

**ClickHouse** — это высокопроизводительная колоночная система управления базами данных (СУБД), предназначенная для онлайн-аналитической обработки данных (OLAP).

### Основные особенности:

- **Колоночное хранение данных**: данные одной колонки хранятся вместе, что ускоряет чтение нужных полей.
- **Векторная обработка**: данные обрабатываются в небольших блоках (векторах), используя SIMD-инструкции для ускорения.
- **Распараллеливание запросов**: крупные запросы автоматически используют все доступные ресурсы сервера.
- **Горизонтальное масштабирование**: можно создать кластер, добавляя новые узлы для увеличения мощности.
- **Асинхронная репликация**: поддержка репликации между узлами для повышения отказоустойчивости.
- **Поддержка SQL-подобного языка запросов**.

ClickHouse особенно эффективен для аналитических задач, где требуется быстро обрабатывать большие объёмы данных.

## Где применяется ClickHouse

ClickHouse подходит для:

- Быстрых запросов по неагрегированной статистике.
- Хранения и анализа логов.
- Систем информационной безопасности (SIEM).
- Телеметрии и метрик устройств.
- Статистики для систем мониторинга (например, Grafana).

Не подходит для:

- Частых изменений данных в режиме реального времени (OLTP-нагрузка).
- Сложных многотабличных JOIN-запросов между большими таблицами.
- Операций с выборкой отдельных строк с минимальной задержкой.

## Устройство ClickHouse

### Колоночная архитектура

- Каждый столбец таблицы хранится отдельно.
- При чтении запроса считываются только нужные столбцы.

### Векторная обработка

- Данные обрабатываются небольшими блоками (векторами).
- Применение SIMD-инструкций увеличивает скорость выполнения запросов.

### Параллельная обработка

- Один запрос может использовать несколько ядер процессора.
- Возможна работа в многосерверной конфигурации (кластер).

## Движки таблиц

### MergeTree

**MergeTree** — основной и самый гибкий движок в ClickHouse.

Особенности:

- Данные сортируются по первичному ключу.
- Поддержка партиционирования данных.
- Автоматическая фоновая слияние данных.
- Поддержка репликации (через ReplicatedMergeTree).
- Поддержка семплирования данных.

**Принцип работы:**

- Данные вставляются небольшими порциями.
- Затем периодически объединяются в более крупные куски.

### Разреженные индексы

- Первичный ключ реализован через **разреженный индекс**.
- Индекс содержит ссылки не на каждую строку, а на группы строк.
- Обеспечивает быстрое ограничение диапазона поиска.

Плюсы:

- Компактность: индекс помещается в оперативной памяти.
- Быстрая фильтрация данных.

Минусы:

- Нет полной адресации строк.
- Возможна "лишняя" загрузка блоков при точечных запросах.
- Индекс не обеспечивает уникальности.

## Режимы работы ClickHouse

### Сингл-инстанс

- Установка на одном сервере.
- Подходит для небольших проектов или начальных этапов.
- Простота развертывания.

Когда стоит использовать:

- Объём данных помещается на одном сервере.
- Нет критичных требований к отказоустойчивости.

### Кластеризация

- Несколько серверов объединяются в кластер.
- Используются координаторы (ZooKeeper или ClickHouse Keeper).
- Поддержка репликации и шардирования данных.
- Повышение отказоустойчивости и производительности.

**Понятия:**

- **Шардирование**: распределение данных по узлам.
- **Репликация**: дублирование данных между узлами для отказоустойчивости.

## Отличия ClickHouse от других СУБД

- Нет классических B-tree индексов.
- Нет внешних ключей, уникальности строк не контролируется.
- Используются фоновые мутации (`ALTER TABLE UPDATE/DELETE`).
- Поддержка PREWHERE для оптимизации фильтрации.
- Диалект SQL отличается от стандартного.
- JSON хранится в текстовом виде.
- Массивы поддерживаются напрямую.

## Когда стоит использовать ClickHouse

- Нужна высокая скорость аналитических запросов по большим объёмам данных.
- Требуется обработка логов, метрик, событий.
- Нет необходимости в частом обновлении отдельных записей.
- Нужно горизонтальное масштабирование хранения.

# Подключение и аутентификация в ClickHouse

## Интерфейсы подключения (Native, HTTP)

ClickHouse поддерживает два основных протокола подключения:

### 1. Native TCP

- Используется клиентом командной строки (`clickhouse-client`) и серверами при обработке распределённых запросов.
- Имеет меньше накладных расходов.
- Реализован на C++, Go, Python.

### 2. HTTP

- Поддерживается практически всеми языками программирования.
- Имеет больше накладных расходов и ограничений по сравнению с Native.
- Подходит для простого и быстрого взаимодействия через стандартные HTTP-запросы.

Оба протокола могут работать через TLS для безопасного шифрования данных.

## Инструменты для работы с ClickHouse

- **clickhouse-client** — консольный клиент для работы с базой данных.
- **JDBC и ODBC драйверы** — для интеграции с различными приложениями и инструментами.
- **Библиотеки на C++, Python, Go и других языках**.

## Аутентификация

Для подключения к ClickHouse используются:

- Логин
- Пароль

## Работа с clickhouse-client

**clickhouse-client** — основной инструмент для подключения и работы с ClickHouse через терминал.

### Подключение

```bash
clickhouse-client --host 127.0.0.1 --port 9000 --user default --password
```

Или интерактивный режим без явного указания параметров:

```bash
clickhouse-client
```

### Параметры

- `--host` — адрес сервера ClickHouse.
- `--port` — порт подключения (по умолчанию 9000 для Native TCP).
- `--user` и `--password` — учётные данные.
- `--secure` — подключение через TLS.
- `--multiquery, -n` — выполнение нескольких SQL-запросов подряд.
- `--multiline, -m` — многострочный режим набора запроса.
- `--stacktrace` — вывод стека ошибок при падениях.

### Примеры работы

**Выполнение запроса:**

```bash
clickhouse-client --query="SELECT version();"
```

**Многострочный режим:**

```bash
clickhouse-client -m
```

**Параметризованный запрос:**

```bash
clickhouse-client --param_limit=10 --query="SELECT * FROM system.numbers LIMIT {limit:UInt64}"
```

## Импорт данных

**Создание таблицы:**

```sql
CREATE TABLE test_import (
    ID Int32,
    name String,
    dt DateTime
) ENGINE = MergeTree()
ORDER BY ID;
```

**Импорт CSV-файла:**

```bash
cat test_data.csv | clickhouse-client --query="INSERT INTO test_import FORMAT CSV"
```

## Экспорт данных

**Экспорт в JSON:**

```bash
clickhouse-client --query="SELECT * FROM test_import" --format JSON > export.json
```

**Экспорт в CSV:**

```bash
clickhouse-client --query="SELECT * FROM test_import" --format CSV > export.csv
```

## Диагностика запросов

**Изменение уровня логирования:**

```sql
SET send_logs_level = 'trace';
```

**Пример вывода с логами:**

```bash
clickhouse-client -n --format=TSV -q "SET send_logs_level = 'trace'; SELECT * FROM system.settings LIMIT 2;" > result.tsv 2>&1
```

## Дополнительные параметры

**Строка подключения:**

```bash
clickhouse://user:password@localhost:9000/database_name
```

Позволяет задавать параметры подключения напрямую в одной строке.

## Графические интерфейсы

Для работы с ClickHouse можно использовать IDE, например **DBeaver**, настроив подключение через JDBC-драйвер.

Основные шаги:

- Установить драйвер ClickHouse в DBeaver.
- Указать параметры подключения (хост, порт, логин, пароль).
- Выбрать базу данных.

# Создание таблиц в ClickHouse: MergeTree

## Особенности работы MergeTree

- Поддержка индексации по первичному ключу (обязателен ключ сортировки `ORDER BY`).
- Данные хранятся в отдельных частях (dataparts).
- Поддержка партиционирования (`PARTITION BY`).
- Возможность семплирования выборок (`SAMPLE BY`).
- Поддержка репликации (движки ReplicatedMergeTree).
- Вторичные индексы называются "индексами пропуска данных".

## Создание таблиц

### Базовый синтаксис `CREATE TABLE`

```sql
CREATE [TEMPORARY] TABLE [IF NOT EXISTS] [db_name.]table_name
(
    column_name [type] [DEFAULT|MATERIALIZED|ALIAS expr] [CODEC] [COMMENT] [TTL expr],
    INDEX index_name expr TYPE type(...) GRANULARITY value
)
ENGINE = MergeTree()
ORDER BY expr
[PARTITION BY expr]
[PRIMARY KEY expr]
[SAMPLE BY expr]
[TTL expr]
[SETTINGS name=value, ...]
```

### Описание полей

- `DEFAULT <expr>` — значение по умолчанию.
- `MATERIALIZED <expr>` — сохраняемое вычисляемое поле.
- `ALIAS <expr>` — вычисляемое поле без хранения.
- `CODEC` — сжатие данных.
- `COMMENT` — комментарий к полю.
- `TTL` — время жизни значения в поле.

### Пример таблицы

```sql
CREATE TABLE example
(
    id UInt64,
    name String DEFAULT 'unknown',
    created_at DateTime,
    expires_at DateTime TTL expires_at + INTERVAL 1 MONTH
)
ENGINE = MergeTree()
ORDER BY id;
```

## Работа с TTL

### Основные моменты

- **TTL на уровне поля**: удаляет данные или сбрасывает поле в значение по умолчанию.
- **TTL на уровне таблицы**: может перемещать части данных на другие диски (`TO DISK` или `TO VOLUME`) или удалять.

### Синтаксис TTL

```sql
TTL expr [DELETE | TO DISK 'disk_name' | TO VOLUME 'volume_name'] [WHERE condition]
```

## Сжатие данных

Поддерживаемые кодеки:

- `NONE`
- `LZ4` (по умолчанию)
- `LZ4HC(level)`
- `ZSTD(level)`

### Указание кодека для поля

```sql
CREATE TABLE compressed_example
(
    id UInt64 CODEC(ZSTD(5)),
    text String CODEC(LZ4)
)
ENGINE = MergeTree()
ORDER BY id;
```

## Индексы пропуска данных

Можно создавать вторичные индексы для ускорения выборок.

```sql
INDEX idx_name expr TYPE minmax GRANULARITY 3
```

## Управление данными и структурами

- `SHOW TABLES` — список таблиц.
- `SHOW COLUMNS FROM table_name` — список столбцов.
- `DROP TABLE table_name` — удалить таблицу.

## Процесс слияния (Merge)

- Данные хранятся в частях.
- Фоновое слияние объединяет части в более крупные.
- `OPTIMIZE TABLE` — ручной запуск внепланового слияния.

### Синтаксис команды `OPTIMIZE`

```sql
OPTIMIZE TABLE table_name [PARTITION partition_expr] [FINAL] [DEDUPLICATE]
```

Параметры:

- `PARTITION` — оптимизировать только указанную партицию.
- `FINAL` — принудительное полное слияние.
- `DEDUPLICATE` — удаление дубликатов.

## Ограничения целостности

Можно задавать `CONSTRAINT` при создании таблиц:

```sql
CREATE TABLE constraint_example
(
    id UInt64,
    age UInt8,
    CONSTRAINT positive_age CHECK age > 0
)
ENGINE = MergeTree()
ORDER BY id;
```

Если при вставке данные не проходят проверку ограничения, будет ошибка.

## Создание, изменение и удаление таблиц

## Вставка, изменение и удаление данных

## Выборка, сортировка, агрегация и группировка данных
